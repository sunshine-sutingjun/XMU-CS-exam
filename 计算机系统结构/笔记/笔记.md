# 计算机系统结构的基础知识
## Amdahl定律

**加速比**
$加速比=\frac{系统性能_{改进后}}{系统性能_{改进前}}=\frac{总执行时间_{改进前}}{总执行时间_{改进后}}$
$S_n=\frac{T_0}{T_n}=\frac1{1-Fe+\frac{Fe}{Se}}$

**可改进比例**
$Fe=\frac{改进前可改进部分的执行时间}{改进前总的执行时间}$

**部件加速比**
$Se=\frac{改进部分改进前执行时间}{改进部分改进后执行时间}$

## CPU性能公式

$CPI_i$ ：第i种指令周期所需的平均周期数
$IC_i$ ：第i种指令出现的次数
$IC$ ：所执行的指令总条数
$CPI$：每条指令的平均周期数
$MIPs$：每秒执行的百万条指令数

$CPU时间周期数=\sum\limits_{i=1}^n(CPI_i\times IC_i)$
$CPU时间=CPI时间周期数\times 时钟周期时间$
$CPI=\frac{CPU时间周期数}{IC}$
$MIPs=\frac{IC}{程序执行时间\times10^6}=\frac{主频}{CPI\times10^6}$

# 指令系统结构的设计
## 指令操作码的优化
1. 赫夫曼编码
2. 等长扩展码（3/3/3、2/7……）
3. 定长操作码

# 流水线技术
## 流水线的性能指标
$T_{pipeline}=\sum\limits_{i=1}^{k}\Delta t_i+(n-1)max(\Delta t_1,\Delta t_2,\cdots,\Delta t_k)$
实际吞吐率：$TP=\frac n{T_{pipeline}}=\frac{结果数}{流水线时间}$
最大吞吐率：${TP}_{max}=\frac1{max(\Delta t_1,\Delta t_2,\cdots,\Delta t_k)}$
加速比：$S=\frac{n\sum\limits_{i=1}^k\Delta t_i}{T_{pipeline}}$
效率：$E=\frac{n\sum\limits_{i=1}^k\Delta t_i}{k\,T_{pipeline}}=\frac{阴影面积}{总矩形面积}$

## 非线性流水线的最优调度
1. 根据预约表写出禁止表$F$
2. 根据禁止表写出初始冲突向量$C_0$
3. 根据初始冲突向量$C_0$画出状态转换图
$C_{new}=SHR^{(j)}(C_k)~XOR~(C_0)$
4. 根据状态转换图写出最优调度方案

## 流水线的相关与冲突
### 五段流水线
1. 取指令周期IF
2. 指令译码/读寄存器周期ID
3. 执行/有效地址计算周期EX
4. 存储器访问/分支完成周期MEM
5. 写回周期WB

<table border="1" cellpadding="8" cellspacing="0">
  <tr>
    <th>阶段\指令</th>
    <th>load</th>
    <th>store</th>
    <th>寄存器-寄存器 ALU</th>
    <th>寄存器-立即数 ALU</th>
    <th>分支</th>
  </tr>
  <tr>
    <td>IF<br/>取指令</td>
    <td colspan="6">
      以程序计数器（PC）中的内容作为地址，从存储器中取出指令并放入指令寄存器（IR），同时 PC 值加 4，指向顺序的下一条指令。
    </td>
  </tr>
  <tr>
    <td>ID<br/>指令译码/读寄存器</td>
    <td colspan="6">
      对指令进行译码，并用 IR 中的寄存器地址去访问通用寄存器组，读出所需的操作数。
    </td>
  </tr>
  <tr>
    <td>EX<br/>执行/有效地址计算</td>
    <td colspan="2">ALU 将指令中指定的寄存器内容<br/>与偏移量相加，<br/>形成访问存储器的有效地址。</td>
    <td>ALU 按照操作码指定的操作，<br/>对从通用寄存器组中<br/>读出的数据进行运算。</td>
    <td>ALU 按照操作码指定的操作，对从通用寄存器组中读出的操作数<br/>和指令中给出的立即数进行运算。</td>
    <td>ALU 将指令中给出的偏移量与 PC 值相加，形成转移目标地址，同时对操作数进行判断，确定分支是否成功。</td>
  </tr>
  <tr>
    <td>MEM<br/>存储器访问/分支完成</td>
    <td>用有效地址<br/>从存储器中读出相应的数据。</td>
    <td>用有效地址<br/>将数据写入存储器。</td>
    <td>无</td>
    <td>无</td>
    <td>如果分支成功，将计算好的转移目标地址送入 PC；否则，不进行任何操作。</td>
  </tr>
  <tr>
    <td>WB<br/>写回</td>
    <td>将从存储器中读出的数据<br/>写入通用寄存器组。</td>
    <td>无</td>
    <td>将 ALU 的运算结果写入通用寄存器组。</td>
    <td>将 ALU 的运算结果写入通用寄存器组。</td>
    <td>无</td>
  </tr>
</table>

### 相关与流水线冲突
#### 相关
1. 数据相关
   一读一写，且有传递性
2. 名相关
   1. 反相关
    读名相同
   2. 输出相关
    写名相同
3. 控制相关
    跟分支有关

#### 流水线冲突
##### 结构冲突
##### 数据冲突
分类
写后读RAW：真数据相关
写后写WAW：输出相关
读后写WAR：反相关

解决方式
定向技术、指令调度

##### 控制冲突
解决方式：冻结、排空、预测分支、延迟分支