2023年

##### 二、

1.

![](C:\Users\Administrator\Desktop\试卷答案\23_2_1.jpg)

```sql
SELECT C.Cname 
FROM C
WHERE NOT EXISTS (
    SELECT * 
    FROM M 
    WHERE NOT EXISTS (
        SELECT * 
        FROM O JOIN H ON  O.Hno = H.Hno
        WHERE M.Mno = O.Mno 
          AND C.Cno = O.Cno 
          AND H.Htype = 'IMAX'
          AND Odate BETWEEN '2023-4-29' AND '2023-5-3'
    )
)AND C.Csex='男';
```

2.

```sql
SELECT Mno,Mname,Mdirect FROM M JOIN I ON M.Mno = I.Mno
WHERE  I.Inum > 2000
AND Mno in (
    SELECT Mno FROM O 
    GROUP BY Mno 
    HAVING SUM(Ocount)>= 0.4*(SELECT SUM(Ocount) FROM O ))
```

3.

```sql
update M 
set Mprice= 0.9*Mprice 
WHERE Mprice > 20 
AND Mno in (
    select TOP 3 Mno FROM R 
    WHERE Rdate BETWEEN '2023-5-22' AND '2023-5-25' 
    GROUP BY Mno 
    ORDER BY SUM(Occunt) DESC, Mno ASC )   
```

4.

```sql
CREATE VIEW 排片信息 AS
SELECT M.Mno,M.Mname,Inum,Idate 
FROM M JOIN I ON M.Mno=I.Mno ;


CREATE VIEW 售票情况 AS
SELECT M.Mno,
       SUM(O.Ocount*M.Mprice)-SUM(R.Rsum) 
FROM O JOIN M ON O.Mno=M.Mno JOIN R ON O.Ono=R.Ono
GROUP BY Mno;


CREATE VIEW 退票信息 AS 
SELECT R.Cno,C.Cname,SUM(Rcount) 
FROM C JOIN R ON C.Cno=R.Cno 
WHERE Rdate > '2022-6-1'
GROUP BY C.Cname,R.Cno;


GRANT SELECT ON 售票情况 TO 市场经理;

GRANT SELECT ON 排片信息 TO 市场经理;

GRANT SELECT ON 退票信息 TO 营运客服;
```

5.

```sql
DECLARE @Mdirect char(10);
DECLARE @Cname char(10);
DECLARE @Output char();
DECLARE cur1 CURSOR
SET @Output='';
FOR SELECT DISTINCT Mdirect FROM M;
BEGIN 
    OPEN cur1;
    FETCH NEXT FROM cur1 INTO @Mdirect;
    SET @Output=@Mdirect +',退票明细：(';
    WHILE(@@FETCH_STATUS = 0)
    BEGIN 
        DECLARE cur2 CURSOR
        FOR SELECT DISTINCT Cname FROM R JOIN M ON R.Mno =M.Mno 
        WHERE Mdirect= @Mdirect AND R.Rdate BETWEEN '2022-01-01' AND '2022-12-31';
        SET
        BEGIN
            OPEN cur2;
            FETCH NEXT FROM cur2 INTO @Cname;
            SET @Output=@Output +@Cname;
            FETCH NEXT FROM cur2 INTO @Cname;
            WHILE(@@FETCH_STATUS = 0)
            BEGIN 
                SET @Output=@Output + ','+ @Cname;
                FETCH NEXT FROM cur2 INTO @Cname;
            END
            @Output=@Output+')';
            PRINT @Output;
            CLOSE cur2;
            DEALLOCATE cur2;
        END
        FETCH NEXT FROM cur1 INTO @Mdirect;
    END
    CLOSE cur1 ;
    DEALLOCATE cur1;
END      
```

6.插入多条数据，需要使用游标

```sql
CREATE TRIGGER 插入订票信息
ON O
FOR INSERT 
AS
BEGIN 
    DECLARE @Mno CHAR(10),@Ocount CHAR(10);
    DECLARE cur1 cursor 
        FOR SELECT Mno,Ocount FROM inserted;
    OPEN cur1;
    FETCH NEXT FROM cur1 INTO @Cno,@Ocount;
    WHILE @@FETCH_STATUS=0
    BEGIN  
        UPDATE K SET Knum=Knum-@Ocount,
                     Kdate='2023-6-27'
        WHERE K.Mno=@Mno;
        FETCH NEXT FROM cur1 INTO @Cno,@Ocount;
    END;
    CLOSE cur1;
    DEALLOCATE cur1;
END;

CREATE TRIGGER 插入退票信息
ON R
FOR INSERT
AS
BEGIN
    DECLARE @Mno CHAR(10);
    DECLARE cur2 CURSOR 
        FOR SELECT Mno FROM INSERTED;
    OPEN cur2;
    FETCH NEXT FROM cur2 INTO @Mno;
    WHILE @@FETCH_STATUS=0
    BEGIN 
        UPDATE I SET Inum=0.95*Inum , 
                     Idate='2023-6-27'
        WHERE I.Mno=@Mno AND I.Mno in(
             SELECT Mno FROM M JOIN H ON M.Hno=H.Hno where H.Htype='IMAX');
        FET
    END;
    CLOSE cur2;
    DEALLOCATE cur2;
END;
```

7.

```sql
CREATE PROC 更改票价 
@Mdirect VARCHAR(10),
@Psum INT
AS
BEGIN
    DECLARE @Osum int;
    DECLARE @Output varchar(200),
            @Oldprice INT,
            @Newprice INT,
            @Mno CHAR(10);
    DECLARE cur1 cursor 
        FOR SELECT  Mno FROM M WHERE Mdirect=@Mdirect;
    OPEN cur1;
    FETCH NEXT FROM cur1 INTO @Mno;
    WHILE @@FETCH_STATUS=0
    BEGIN 
        SET @Osum=(SELECT SUM(Ocount*Mprice) FROM O JOIN M ON O.Mno=M.Mno 
           WHERE O.Mdirect=@Mdirect) AND M.Mno=@Mno ;

        SET @Oldprice= (SELECT Mprice FROM M WHERE M.Mno=@Mno);

        IF  @Osum< @Psum
        BEGIN
            UPDATE M SET Mprice=0.95*Mprice WHERE M.Mprice >20 AND Mdirect=@Mdirect;
            SET @Newprice = (SELECT Mprice FROM M WHERE M.Mno=@Mno);
            SET @Output=@Mno + '-' + @@Oldprice + '-' +@Newprice;
        END
        ELSE 
        BEGIN
            IF @Osum> @Psum
            BEGIN
                UPDATE M SET Mprice=1.05*Mprice WHERE M.Mprice < 25 AND Mdirect=@Mdirect;
                SET @Newprice = (SELECT Mprice FROM M WHERE M.Mno=@Mno);
                SET @Output=@Mno + '-' + @@Oldprice + '-' +@Newprice;
            END
            ELSE 
        END
    FETCH NEXT FROM cur1 INTO @Mno;
    END

    CLOSE cur1;
    DEALLOCATE cur1;
END
```
