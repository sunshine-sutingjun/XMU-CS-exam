## 第八章 NoSql数据库
### 8.1 NoSQL简介
NoSql是非关系数据库的通称，采用数据模型，类似键值，列族，文档等非关系模型。
没有表结构，不严格遵守ACID约束条件。

#### NoSQL的定义与核心特点p182
- 灵活的可扩展性（横向扩展）  
- 灵活的数据模型（关系代数为基础，非结构化/半结构化）  
- 与云计算紧密融合（水平扩展，根据资源自由伸缩）

#### 应用企业举例
- Google, Facebook, Mozilla, Adobe, 腾讯, 阿里等互联网公司  

### 8.2 NoSQL兴起的原因
#### 关系数据库在Web 2.0时代的不足
- 无法满足海量数据管理需求
- 无法满足数据高并发的需求  
- 无法满足高可扩展性与高可用性的需求

#### 关系数据库关键特性在Web 2.0中是鸡肋
Web2.0网站系统：
- 无需严格事务机制  
- 不要求严格的实时读写一致性  
- 复杂SQL查询减少（单表主键查询，以存储空间换查询性能） 

#### 业务场景分化
- 数据分析（高吞吐）与在线业务（低延迟）需不同架构  
- Hadoop（分析） vs. MongoDB/Redis（在线业务）

### 8.3 NoSQL与关系数据库的比较
| **对比维度** | **关系数据库**  | **NoSQL数据库**  |
|--|--|--|
| **理论基础** | 关系代数理论完善 | 缺乏数学理论基础 |
| **事务支持** | 支持ACID强事务（原子性、一致性、隔离性、持久性） | 大多不支持强事务一致性  |
| **数据模型** | 结构化数据，固定Schema | 灵活数据模型（半/非结构化），无Schema约束 |
| **扩展性** | 垂直扩展为主，横向扩展困难 | 强大的横向扩展能力（弹性伸缩）  |
| **查询能力** | 复杂SQL查询高效（支持索引、连接等） | 复杂查询性能弱，简单查询高效 |
| **数据规模** | 难以支持海量数据 | 支持超大规模数据存储  |
| **可用性** | 单点故障影响大 | 高可用性（分布式架构）  |
| **典型应用场景** | 银行、电信等强一致性业务（如交易系统）  | 互联网非关键业务（如数据分析、用户画像） |
| **代表产品** | MySQL、SQL Server、PostgreSQL  | Redis、MongoDB、HBase |

#### 关系数据库的优劣势
- 优势：理论完善、ACID事务、高效查询、技术成熟  
- 劣势：扩展性差、模型僵化、难以支持海量数据  

#### NoSQL的优劣势
- 优势：超大规模数据支持、灵活模型、高扩展性  
- 劣势：无数学理论支持、复杂查询弱、事务一致性弱、维护困难  

#### 适用场景对比
- 关系数据库：银行/电信等强事务场景  
- NoSQL：互联网非关键业务（如数据分析）  

#### 混合架构案例（亚马逊）
- 键值存储（购物篮） + 关系数据库（产品订单） + 文档数据库（历史订单）  

### 8.4 NoSQL的四大类型

| 类型 | 数据结构 | 典型场景 | 代表产品 | 优点  |缺点|
|--|--|--|-|-|-|
| **键值数据库** | 键值对| 缓存、会话、配置、参数、购物车 | Redis、Riak、Memcached | 扩展性、灵活性好，大量写操作时性能好 |无法存储结构化信息、条件查询效率低|
| **列族数据库** | 列族 |分布式数据存储与管理 | HBase、Cassandra | 查找速度快，可扩展性强，分布式扩展，复杂性低  | 功能少，不支持强事务一致性|
| **文档数据库** | JSON/XML/YAML | 文档或半结构化数据 | MongoDB、RavenDB | 性能好、灵活性高、复杂性低、数据结构灵活 |缺乏统一的查询语法|
| **图数据库** | 图结构  | 社交网络、推荐系统、欺诈检测 | Neo4j | 灵活性高、支持复杂的图算法与关系图谱 | 复杂性高，数据规模限制 |

（Redis支持更多数据类型（如列表、集合），而Memcached仅支持字符串。）

### 8.5 NoSQL的三大基石
“帽子”CAP理论，“基础”BASE原则，最终一致性！

#### CAP理论
- C（Consistency，一致性）：读能读到完成的写数据，分布式环境，所有节点数据实时一致  
- A（Availability，可用性）：快速获取数据，请求必有响应  
- P（Tolerance of Network Partition，分区容忍性）：网络分区时，分离的系统仍可用

> *一致性，操作系统最后一题的分布式快照算法？*

三者不可兼得！（CA/CP/AP三选二）

|策略|方法|典型|缺点|
|-|-|-|-|
|CA| 事务相关内容放在同一台设备上 | MySQL |可扩展性差|
|CP| 服务器等待 | Neo4J、HBase | 等待期间无法提供对外服务|
|AP| 允许系统返回不一致的数据，Web2.0喜欢的（即时发微博） | Riak | - |

#### BASE原则
数据库事务的ACID特性（酸）：

- A（Atomicity，原子性）：原子工作单元
- C（Consistency，一致性）：数据一致
- I（Isolation，隔离性）：并发事务修改隔离
- D（Durability，持久性）：修改永久

NoSql的BASE原则（碱）：

- BA（Basically Available基本可用）：部分故障时其余部分可用  
- S（Soft state，软状态）：允许数据中间状态（非实时一致）
- E（Eventual consistency，最终一致性）：数据最终达到一致（如DNS系统），对应ACID中C的最终目的

#### 最终一致性
- 因果一致性、读己之所写、会话一致性、单调读、单调写  

### 8.6 从NoSQL到NewSQL数据库
#### NewSQL的定位
- 融合关系数据库（ACID）与NoSQL（高扩展性）的优势  
#### 数据库演进趋势
- 关系数据库 → NoSQL（解决扩展性问题） → NewSQL（兼顾事务与扩展）  
