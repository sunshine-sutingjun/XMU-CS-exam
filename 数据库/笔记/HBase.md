## 第九章 分布式数据库HBase
### 9.1 概述
#### HBase的起源  
- 是Google BigTable的开源实现  
- 核心目标：存储非结构化和半结构化松散数据，支持超大规模表（10亿行×百万列）  

#### HBase与传统关系数据库的对比
  | 对比维度  | HBase  | 关系数据库  |  
  |--|--|--|  
  | 数据类型  | 所有数据视为字符串（无类型解释）  | 支持丰富数据类型  |  
  | 数据操作  | 仅支持简单操作（插入/查询/删除），无多表连接 | 支持复杂SQL操作与多表连接  |  
  | 存储模式  | 列存储（按列族分离文件）  | 行存储  |  
  | 索引机制  | 仅行键索引  | 支持多列复杂索引  |  
  | 数据更新  | 保留历史版本（时间戳索引）  | 覆盖旧值  |  
  | 扩展性  | 水平扩展灵活（分布式集群）  | 水平扩展困难，垂直扩展有限  |  

#### HBase的必要性  
- Hadoop MapReduce无法满足实时处理需求  
- HDFS仅支持批量访问，不支持随机访问  
- 关系数据库无法解决海量数据下的扩展性问题  


### 9.3 HBase数据模型
#### 核心概念  
- 表（Table）：由行和列组成，列划分为列族  
- 行键（Row Key）：唯一标识一行数据，按字典序排序  
- 列族（Column Family）：基本访问控制单元，动态扩展  
- 列限定符（Qualifier）：列族内的具体列标识  
- 单元格（Cell）：由`[行键, 列族, 列限定符, 时间戳]`定位，存储字节数组  
- 时间戳（Timestamp）：数据版本索引，支持多版本共存  

#### 存储特性  
- 稀疏多维映射表：数据按行键、列族、列限定符、时间戳四维坐标组织  
- 列式存储：  
- 列族独立存储（如`contents`和`anchor`列族物理分离）  
- 优势：高效压缩、快速列聚合查询  
- 物理视图 vs 概念视图：  
- 概念视图：按行展示（表9-4）  
- 物理视图：按列族存储（表9-5）  


### 9.4 HBase实现原理
#### 核心组件  
  | 组件  | 功能  |  
  |--|--|  
  | 客户端  | 缓存Region位置信息，直接访问Region服务器  |  
  | Master  | 管理Region分配、负载均衡、故障恢复（Region迁移）  |  
  | Region服务器  | 存储Region，处理读写请求  |  
  | ZooKeeper  | 选举Master，监控Region服务器状态，维护hbase:meta表位置  |  

#### Region管理  
- Region分裂：  
- 初始表→1个Region → 数据增大→分裂为多个子Region（图9-6）  
- 分裂后子Region分布在不同服务器（图9-7）  
- Region定位：  
- 两层定位结构（0.96+版本）：  
  1. 客户端通过ZooKeeper定位hbase:meta表所在的Region服务器  
  2. 查询hbase:meta表获取目标Region位置（图9-10）  

#### Region服务器容量  
- 单Region大小：1GB–2GB（2013年后硬件）  
- 单Region服务器管理：10–1000个Region  


### 9.5 HBase运行机制
#### 读写流程  
- 写入流程：  
  1. 数据同时写入MemStore（内存缓存）和HLog（预写日志）  
  2. 写入HLog后返回客户端成功  
- 读取流程：  
  1. 优先读取MemStore → 未命中则读StoreFile（磁盘文件）  

#### 数据持久化与恢复  
- MemStore刷写：周期性刷写到StoreFile生成新文件  
- StoreFile合并：小文件合并成大文件（Store.compact()）  
- 故障恢复：  
- ZooKeeper监测故障 → Master拆分故障服务器的HLog → 按Region分发日志 → 新Region服务器重做日志恢复数据  

#### HLog核心作用  
- 预写日志（Write Ahead Log）保证数据持久性  
- 共用日志设计：提升写入性能，但恢复时需按Region拆分日志  


### 9.6 关键设计思想
#### 列式存储优势（图9-3, 9-4）  
- 行式数据库：适合事务处理，读取整行快  
- 列式数据库：适合分析场景，可快速读取特定列，压缩效率高  

#### CAP权衡  
- 通过HLog+ZooKeeper实现高可用和分区容忍性（AP），弱化强一致性  
